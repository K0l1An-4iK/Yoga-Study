@page "/registerAnket"
@using Шилов.Components.Classes;
@using Npgsql
@inject NpgsqlConnection dbConnection
@inject NavigationManager NavigationManager
<Sidebar/>

<div class="main-content">
    <h1>Регистрация анкеты пользователя</h1>
    <input @bind=login id="login" type="text" placeholder="Введите login" />
    <input @bind=email id="email" type="email" placeholder="Введите email" />
    <input @bind=password id="password" type="password" placeholder="Введите пароль" />
    <input @bind=firstname id="firstName" type="text" placeholder="Введите имя" />
    <input @bind=lastname id="lastName" type="text" placeholder="Введите фамилию" />
    <input @bind=role id="role" type="text" />
    <input @bind=ageText id="age" type="text" placeholder="Введите возраст" />
    <input @bind=lv_training id="lv_training" type="text" placeholder="Введите уровень подготовки" />
    <input @bind=goal id="goal" type="text" placeholder="Введите цель занятий" />
    <input @bind=protivipokazania id="protivipokazania" type="text" placeholder="Введите противопоказания (если есть)" />
    <select @bind="group_id" class="form-input">
        <option value="">-- Выберите группу --</option>
        @foreach (var group in groups)
        {
            <option value="@group.Id">Группа @group.Id</option>
        }
    </select>
    <input @onclick=AddAnket id="Addanket" type="button" value="Добавить анкету" />
    <input @onclick=Cancel id="Cancel" type="button" value="Отмена" />
    @if (!string.IsNullOrEmpty(message))
    {
        <div>@message</div>
    }
</div>
<style>
    /* Добавляем стили для select */
    .form-input {
    width: 100%;
    padding: 0.55rem 0.8rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background-color: #f9f9f9;
    appearance: none; /* Убираем стандартный вид */
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
    line-height: 1.3;
    }

    .form-input:focus {
    border-color: #4a6491;
    outline: none;
    box-shadow: 0 0 0 3px rgba(74, 100, 145, 0.2);
    background-color: #fff;
    }


    .main-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem;
    gap: 1rem; /* Расстояние между элементами */
    max-width: 800px;
    margin: 0 auto;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .main-content h1 {
    color: #2c3e50;
    margin-bottom: 1.5rem;
    font-size: 2rem;
    text-align: center;
    }

    .main-content input {
    width: 100%;
    padding: 0.55rem 0.8rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background-color: #f9f9f9;
    line-height: 1.3;
    }

    .main-content input:focus {
    border-color: #4a6491;
    outline: none;
    box-shadow: 0 0 0 3px rgba(74, 100, 145, 0.2);
    background-color: #fff;
    }

    .main-content input::placeholder {
    color: #95a5a6;
    opacity: 1;
    }

    /* Стили для разных типов полей */
    .main-content input[type="password"] {
    letter-spacing: 1px;
    }

    .main-content input[type="number"] {
    -moz-appearance: textfield;
    }

    .main-content input[type="number"]::-webkit-outer-spin-button,
    .main-content input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
    }
</style>
@code {
    Anket newAnket = new Anket();
    List<Group> groups = new List<Group>();
    public string message = string.Empty;
    public string login = string.Empty;
    public string email = string.Empty;
    public string password = string.Empty;
    public string firstname = string.Empty;
    public string lastname = string.Empty;
    public string role = "Клиент";
    public string ageText { get; set; } = string.Empty;
    public string lv_training = string.Empty;
    public string goal = string.Empty;
    public string protivipokazania = string.Empty;
    public int group_id;

    protected override async Task OnInitializedAsync()
    {
        groups = await Group.GetListGroup(dbConnection);
    }
    private async Task AddAnket()
    {
        User newuser = new User();
        var userExists = await User.GetUser(login, email, password, dbConnection);

        if (userExists.Id == -1)
        {
            newuser.email = email;
            newuser.password = password;
            newuser.login = login;
            newuser.FirstName = firstname;
            newuser.LastName = lastname;
            newuser.role = role;
            newuser.login = login;
            int age = Int32.Parse(ageText);
            await User.AddUser(newuser, dbConnection);
            User user = await User.GetUser(login, email, password, dbConnection);
            Anket anket = new Anket(user.Id, age, lv_training, goal, protivipokazania);
            await Anket.AddAnket(anket, dbConnection);
            Client client = new Client(user, group_id, anket.Id);
            //await Client.AddClient(client, dbConnection);
            await Group.AddClientInGroup(client, dbConnection);
            NavigationManager.NavigateTo("/adminManager");
        }
        else
        {
            message = "Пользователь с таким email или логином уже существует.";
        }
    }
    private void Cancel()
    {
        NavigationManager.NavigateTo("/adminManager");
    }
}
