@page "/expenses"
@using System.ComponentModel.DataAnnotations
@using Npgsql
@using Шилов.Components.Classes
@inject NpgsqlConnection dbConnection
@inject IJSRuntime JSRuntime

<Sidebar />

<div class="main-content">
    <h2><i class="fas fa-file-invoice-dollar"></i> Учет расходов</h2>

    <div class="form-section">
        <EditForm Model="@newExpense" OnValidSubmit="AddExpense">
            <DataAnnotationsValidator />

            <div class="form-row">
                <div class="form-group">
                    <label>Сумма (₽)</label>
                    <InputNumber @bind-Value="newExpense.sum" class="form-input" placeholder="0" />
                </div>

                <div class="form-group">
                    <label>Дата</label>
                    <InputDate @bind-Value="newExpense.date" class="form-input" />
                </div>
            </div>

            <div class="form-group">
                <label>Описание</label>
                <InputTextArea @bind-Value="newExpense.Descript" class="form-input" rows="2" />
            </div>
            <div class="form-group">
                <label>Категория</label>
                <select @bind=CurrentCategory>
                    <option value="">Выберите категорию</option>
                    @foreach (string categ in Category)
                    {
                        <option value=@categ>@categ</option>
                    }
                </select>
            </div>
            <div class="form-actions">
                <button type="submit" class="action-btn add-button">
                    <i class="fas fa-save"></i> Сохранить
                </button>
                <button type="button" @onclick="ClearForm" class="action-btn">
                    <i class="fas fa-eraser"></i> Очистить
                </button>
            </div>
        </EditForm>
    </div>

    <div class="summary-section">
        <div class="summary-card">
            <span>Всего расходов:</span>
            <span class="total-amount">@expenses.Sum(e => e.sum).ToString("N0") ₽</span>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Дата</th>
                <th>Сумма</th>
                <th>Описание</th>
                <th>Категория</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            @if (expenses.Any())
            {
                @foreach (var expense in expenses.OrderByDescending(e => e.date))
                {
                    <tr>
                        <td>@expense.date.ToString("dd.MM.yyyy")</td>
                        <td>@expense.sum.ToString("N0") ₽</td>
                        <td>@expense.Descript</td>
                        <td>@expense.category</td>
                        <td class="actions-cell">
                            <button @onclick="@(() => DeleteExpense(expense.Id))" class="action-btn deleteButton">
                                <i class="fas fa-trash"></i> Удалить
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="4" style="text-align: center;">Нет данных о расходах</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private List<Report> expenses = new List<Report>();
    private Report newExpense = new Report { date = DateTime.Now };
    private string[] Category = { "ЗП сотрудникам", "Налоги", "Оплата аренды", "Поломка оборудования", "Прочее" };
    private string CurrentCategory = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadExpenses();
    }

    private async Task LoadExpenses()
    {
        try
        {
            expenses = await Report.GetListExpenses(dbConnection);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Ошибка загрузки: {ex.Message}");
        }
    }

    private async Task AddExpense()
    {
        if (newExpense.sum <= 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Сумма должна быть больше 0");
            return;
        }

        if (string.IsNullOrWhiteSpace(newExpense.Descript))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Укажите описание расхода");
            return;
        }
        if (string.IsNullOrWhiteSpace(CurrentCategory))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Выберите категорию");
            return;
        }
        await Report.SaveExpenses(newExpense.sum, newExpense.Descript, CurrentCategory, newExpense.date, dbConnection);
        CurrentCategory = string.Empty;
        await LoadExpenses();
        ClearForm();
    }

    private async Task DeleteExpense(int id)
    {
        await Report.DeleteExp(id, dbConnection);
        await LoadExpenses();
    }

    private void ClearForm()
    {
        newExpense = new Report { date = DateTime.Now };
    }
}

<style>


    select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        font-family: inherit;
        background-color: #fff;
        color: #2c3e50;
        appearance: none;
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 10px 6px;
        cursor: pointer;
        margin-bottom: 15px;
    }

        select:focus {
            outline: none;
            border-color: #4e73df;
            box-shadow: 0 0 0 2px rgba(78, 115, 223, 0.25);
        }







    .main-content {
        padding: 20px;
        margin-left: 250px; /* Отступ под сайдбар */
    }

    h2 {
        color: #2c3e50;
        margin-bottom: 20px;
    }

    .form-section {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .form-group {
        flex: 1;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #5a5c69;
    }

    .form-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .summary-section {
        margin-bottom: 20px;
    }

    .summary-card {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        display: inline-flex;
        align-items: center;
        gap: 10px;
    }

    .total-amount {
        font-weight: 600;
        color: #e74a3b;
        font-size: 1.2rem;
    }

    /* Основной стиль таблицы */
    table {
        width: 100%;
        border-collapse: collapse;
        text-align: center;
        margin: 20px 0;
        font-family: "Segoe UI", Roboto, sans-serif;
        font-size: 0.95rem;
        line-height: 1.5;
        color: #2c3e50;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        overflow: hidden;
    }

    /* Ячейки-заголовки таблицы */
    th {
        background-color: #f5f5f5;
        color: #333;
        padding: 10px 12px;
        letter-spacing: 0.5px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9rem;
        border: 1px solid #ddd;
    }

    /* Обычные ячейки данных */
    td {
        padding: 10px 13px;
        background-color: #fafafa;
        border: 1px solid #ddd;
        vertical-align: middle;
        color: #444;
        font-weight: 400;
    }

    /* Эффект при наведении на строку */
    tr:hover td {
        background-color: #f0f0f0;
        transition: background-color 0.3s;
    }

    /* Убираем левые и правые границы */
    table, th, td {
        border-left: none;
        border-right: none;
    }

    .actions-cell {
        display: flex;
        justify-content: center;
        gap: 8px;
    }

    .action-btn {
        padding: 0.6rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .add-button {
        background-color: #4e73df;
        color: white;
    }

    .deleteButton {
        background-color: #f44336;
        color: white;
    }

    .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        opacity: 0.9;
    }

    .action-btn i {
        font-size: 0.9rem;
    }
</style>