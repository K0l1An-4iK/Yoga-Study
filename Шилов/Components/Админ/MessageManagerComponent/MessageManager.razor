@page "/messageManager"
@using Шилов.Components.Classes;
@using Npgsql
@inject NpgsqlConnection dbConnection
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<Sidebar />
<link href="/ModalWindowStyle.css" rel="stylesheet" />

<link href="/TableStyle.css" rel="stylesheet" />

<div class="main-content">
    <h2>Рассылка уведомлений</h2>

    <!-- Блок ввода сообщения -->
    <div class="message-input-container">
        <textarea @bind="messageText" placeholder="Введите текст сообщения..." class="message-textarea"></textarea>
        <button @onclick="SendMessagesToSelected" class="send-button">
            Отправить выбранным (@selectedCount)
        </button>
    </div>

    <div class="main-select">
        <div class="form_radio_group">
            <div class="form_radio_group-item">
                <input @onclick="listClients" id="radio-1" type="radio" name="radio" value="1" checked>
                <label for="radio-1">Клиенты</label>
            </div>
            <div class="form_radio_group-item">
                <input @onclick="listInstructor" id="radio-2" type="radio" name="radio" value="2">
                <label for="radio-2">Инструкторы</label>
            </div>
            <div class="form_radio_group-item">
                <input @onclick="listUsers" id="radio-3" type="radio" name="radio" value="3">
                <label for="radio-3">Все пользователи</label>
            </div>
            <div class="search-container">
                <div class="search-input-group">
                    <input @bind=searchText type="text" placeholder="Фамилия, login или email" class="search-input" />
                    <button @onclick="() => Search(searchText)" class="search-button">Поиск</button>
                </div>
            </div>
        </div>
    </div>

    <div class="zg">
        <div class="select-all-container">
            <input type="checkbox" @bind="SelectAllCheckbox" id="selectAll" />
            <label for="selectAll">Выбрать все</label>
            <span class="selected-count">Выбрано: @selectedCount</span>
        </div>
    </div>

    <!-- Добавлен контейнер для таблицы -->
    <div class="table-container">
        <table class="user-table">
            <thead>
                <tr>
                    <th></th>
                    <th>ID</th>
                    <th>Фамилия</th>
                    <th>Имя</th>
                    <th>Роль</th>
                    <th>Логин</th>
                    <th>Email</th>
                    <th>Пароль</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in showusers)
                {
                    <tr class="@(IsSelected(user) ? "selected-row" : "")">
                        <td>
                            <input type="checkbox"
                            checked="@IsSelected(user)"
                            @onchange="@((e) => ToggleUserSelection(user, (bool)e.Value))" />
                        </td>
                        <td>@user.Id</td>
                        <td>@user.LastName</td>
                        <td>@user.FirstName</td>
                        <td>@user.role</td>
                        <td>@user.login</td>
                        <td>@user.email</td>
                        <td>@user.password</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    /*Поиск*/
    .search-container {
    display: inline-block;
    vertical-align: top;
    margin-left: 20px;
    }

    .search-label {
    font-size: 14px;
    color: #555;
    margin-bottom: 4px;
    font-weight: 500;
    }

    .search-input-group {
    display: flex;
    align-items: center;
    }

    .search-input {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 8px 0 0 8px;
    font-size: 16px;
    width: 250px;
    height: 40px;
    outline: none;
    transition: border-color 0.3s;
    }

    .search-input:focus {
    border-color: #4a6bff;
    }

    .search-button {
    padding: 0 16px;
    height: 40px;
    background-color: #4a6bff;
    color: white;
    border: none;
    border-radius: 0 8px 8px 0;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
    }

    .search-button:hover {
    background-color: #3a5bef;
    }

    /* Остальные стили без изменений */
    .main-select {
    margin-top: 60px;
    margin-bottom: 30px;
    }

    .form_radio_group {
    display: inline-block;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .form_radio_group-item {
    display: inline-block;
    }

    .form_radio_group input[type=radio] {
    display: none;
    }

    .form_radio_group label {
    display: inline-block;
    cursor: pointer;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 500;
    color: #555;
    background: #fff;
    transition: all 0.3s ease;
    border: 1px solid #e0e0e0;
    }

    .form_radio_group .form_radio_group-item:first-child label {
    border-radius: 8px 0 0 8px;
    border-right: none;
    }

    .form_radio_group .form_radio_group-item:last-child label {
    border-radius: 0 8px 8px 0;
    }

    .form_radio_group input[type=radio]:checked + label {
    background: #4a6bff;
    color: white;
    border-color: #4a6bff;
    }

    .form_radio_group label:hover {
    background: #f5f5f5;
    }

    .message-input-container {
    margin: 20px 0;
    display: flex;
    flex-direction: column;
    gap: 15px;
    }

    .message-textarea {
    width: 100%;
    height: 100px; /* Фиксированная высота */
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    resize: none; /* Запрет изменения размера */
    font-family: inherit;
    font-size: 16px;
    }

    .send-button {
    padding: 12px 24px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    align-self: flex-start;
    }

    .send-button:hover {
    background-color: #45a049;
    }

    .send-button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
    }

    .selected-count {
    margin-left: auto;
    font-weight: 500;
    color: #555;
    }

    .main-content {
    height: 98vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    }

    .table-container {
    flex: 1;
    overflow-y: auto;
    margin-top: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    }

    .user-table {
    width: 100%;
    border-collapse: collapse;
    }

    /* Фиксированный заголовок таблицы при скролле */
    .user-table thead tr {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
    }
</style>

@code {
    List<User> users = new List<User>();
    List<User> showusers = new List<User>();
    Dictionary<int, bool> selectedUsers = new Dictionary<int, bool>();
    bool selectAll = false;
    string messageText = string.Empty;
    int selectedCount = 0;
    bool isSending = false;

    protected override async Task OnInitializedAsync()
    {
        users = await User.GetListUsers(dbConnection);
        listClients();
        UpdateSelectedCount();
    }

    private bool IsSelected(User user)
    {
        return selectedUsers.TryGetValue(user.Id, out var selected) && selected;
    }

    private void ToggleUserSelection(User user, bool isSelected)
    {
        selectedUsers[user.Id] = isSelected;
        selectAll = showusers.All(u => IsSelected(u));
        UpdateSelectedCount();
    }

    private void ToggleSelectAll()
    {
        foreach (var user in showusers)
        {
            selectedUsers[user.Id] = selectAll;
        }
        UpdateSelectedCount();
    }

    private void UpdateSelectedCount()
    {
        selectedCount = selectedUsers.Count(kv => kv.Value);
    }

    private void listClients()
    {
        showusers = users.Where(u => u.role == "Клиент").ToList();
        selectAll = false;
        UpdateSelectedCount();
    }

    private void listInstructor()
    {
        showusers = users.Where(u => u.role == "Инструктор").ToList();
        selectAll = false;
        UpdateSelectedCount();
    }

    private void listUsers()
    {
        showusers = users.ToList();
        selectAll = false;
        UpdateSelectedCount();
    }

    private bool SelectAllCheckbox
    {
        get => selectAll;
        set
        {
            if (selectAll != value)
            {
                selectAll = value;
                ToggleSelectAll();
            }
        }
    }

    private async Task SendMessagesToSelected()
    {
        if (string.IsNullOrWhiteSpace(messageText))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Введите текст сообщения");
            return;
        }

        if (selectedCount == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Выберите хотя бы одного получателя");
            return;
        }

        isSending = true;

        try
        {
            var selectedUserIds = selectedUsers.Where(kv => kv.Value).Select(kv => kv.Key).ToList();

            foreach (var userId in selectedUserIds)
            {
                await Message.SendMessage(userId, messageText, dbConnection);
            }

            await JSRuntime.InvokeVoidAsync("alert", $"Сообщение отправлено {selectedCount} пользователям");
            messageText = string.Empty;
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Ошибка при отправке: {ex.Message}");
        }
        finally
        {
            isSending = false;
        }
    }

    string searchText = string.Empty;

    private void Search(string text)
    {
        showusers = new List<User>();

        foreach(var us in users)
        {
            if (TextExt(us.login).Equals(TextExt(text)) || TextExt(us.LastName).Equals(TextExt(text)) || TextExt(us.email).Equals(TextExt(text)))
            {
                showusers.Add(us);
            }
        }
    }

    private string TextExt(string text)
    {
        string newText = text.ToLower().Trim();
        return newText;
    }
}