@page "/clientProfile/{Id:int}"
@using Шилов.Components.Classes;
@using Npgsql
@inject NpgsqlConnection dbConnection
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<SidebarForClient ClientId="@Id" />

<div class="main-content">
    <div class="profile-container">
        <div class="profile-header">
            <h1>Редактирование профиля клиента</h1>
            <div class="header-actions">
                <button @onclick="SaveChanges" class="save-button">
                    <i class="fas fa-save"></i> Сохранить
                </button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert alert-@(isError ? "danger" : "success")">@message</div>
        }

        <div class="profile-content">
            <div class="profile-section">
                <h2><i class="fas fa-user-circle"></i> Основная информация</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Логин</label>
                        <input @bind="currentClient.login" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input @bind="currentClient.email" type="email" class="form-input" />
                    </div>
                    <div class="form-group password-group">
                        <label>Пароль</label>
                        <div class="password-input-container">
                            <input @bind="currentClient.password"
                            type="@(showPassword ? "text" : "password")"
                            class="form-input" />
                            <button class="toggle-password" @onclick="TogglePasswordVisibility">
                                <i class="fas @(showPassword ? "fa-eye-slash" : "fa-eye")"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Имя</label>
                        <input @bind="currentClient.FirstName" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label>Фамилия</label>
                        <input @bind="currentClient.LastName" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label>Статус</label>
                        <input value="Обычный" class="form-input" disabled/>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h2><i class="fas fa-info-circle"></i> Анкетные данные</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Возраст</label>
                        <input @bind="currentAnket.age" type="number" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label>Цель занятий</label>
                        <input @bind="currentAnket.goal" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label>Противопоказания</label>
                        <input @bind="currentAnket.protivipokazania" class="form-input" />
                    </div>
                    <div class="form-group">
                        <label>Группа</label>
                        <input @bind="group.name" class="form-input" disabled/>
                    </div>
                    <div class="form-group full-width">
                        <label>Уровень подготовки</label>
                        <textarea @bind="currentAnket.lv_training"
                        class="form-input textarea-fixed"
                        rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    h1{
    color: #2c3e50;
    }
    /* Основные стили остаются без изменений */
    .profile-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .textarea-fixed {
    resize: none;
    height: 80px;
    min-height: 80px;
    max-height: 80px;
    overflow-y: auto;
    line-height: 1.5; /* Для лучшего отображения текста */
    }
    /* Стиль для группы с паролем */
    .password-group {
    position: relative;
    }

    .password-input-container {
    position: relative;
    }

    .toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
    }

    /* Стиль для textarea */
    .full-width {
    grid-column: 1 / -1;
    }

    .textarea-input {
    min-height: 80px;
    resize: vertical;
    }

    /* Отключенное поле */
    .form-input:disabled {
    background-color: #f5f5f5;
    color: #555;
    }

    .profile-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
    }

    .header-actions {
    display: flex;
    gap: 10px;
    }

    .profile-content {
    display: grid;
    gap: 30px;
    }

    .profile-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 6px;
    }

    .profile-section h2 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #2c3e50;
    font-size: 1.3rem;
    }

    .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    }

    .form-group {
    margin-bottom: 15px;
    }

    .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #555;
    }

    .form-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    }

    .form-textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    resize: vertical;
    min-height: 80px;
    resize: none;
    }

    .save-button {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    }

    .cancel-button {
    background: #f44336;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    }

    .alert {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    }

    .alert-danger {
    background: #ffdddd;
    color: #721c24;
    border: 1px solid #f5c6cb;
    }

    .alert-success {
    background: #ddffdd;
    color: #155724;
    border: 1px solid #c3e6cb;
    }
</style>

@code {
    [Parameter] public int Id { get; set; }

    private Client currentClient = new Client();
    private Anket currentAnket = new Anket();
    private Group group = new Group();
    private string message = string.Empty;
    private bool isError = false;
    private bool showPassword = false;

    protected override async Task OnInitializedAsync()
    {
        currentClient = await Client.GetClient(Id, dbConnection);
        currentAnket = await Anket.GetAnket(Id, dbConnection);
        group = await Group.GetGroup(currentClient.group_id, dbConnection);
    }

    private async Task SaveChanges()
    {
        if (string.IsNullOrWhiteSpace(currentClient.login) ||
            string.IsNullOrWhiteSpace(currentClient.email) ||
            string.IsNullOrWhiteSpace(currentClient.FirstName) ||
            string.IsNullOrWhiteSpace(currentClient.LastName) ||
            currentAnket.age <= 0)
        {
            message = "Пожалуйста, заполните все обязательные поля";
            isError = true;
            return;
        }

        try
        {
            await Client.EditClient(currentClient, currentAnket, dbConnection);
            message = "Данные успешно сохранены";
            isError = false;
            currentClient = await Client.GetClient(Id, dbConnection);
            currentAnket = await Anket.GetAnket(Id, dbConnection);
        }
        catch (Exception ex)
        {
            message = $"Ошибка при сохранении: {ex.Message}";
            isError = true;
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }
}